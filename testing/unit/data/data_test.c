#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "assembler.h"
#include "memory.h"

#define LITTLE 0
#define BIG 1

int errors = 0;

struct _tests
{
  char *source;
  uint8_t answer[16];
  int length;
  int endian;
};

struct _tests tests[] =
{
  { ".db 0x01, 0x02, 0x03, 0x04", { 0x01, 0x02, 0x03, 0x04 }, 4, LITTLE },
  { ".db 0x01, 0x02, 0x03, 0x04", { 0x01, 0x02, 0x03, 0x04 }, 4, BIG },
  { ".dc.b 0x01, 0x02, 0x03, 0x04", { 0x01, 0x02, 0x03, 0x04 }, 4, LITTLE },
  { ".dc.b 0x01, 0x02, 0x03, 0x04", { 0x01, 0x02, 0x03, 0x04 }, 4, BIG },
  { ".dw 0x0102, 0x0304", { 0x02, 0x01, 0x04, 0x03 }, 4, LITTLE },
  { ".dw 0x0102, 0x0304", { 0x01, 0x02, 0x03, 0x04 }, 4, BIG },
  { ".dc16 0x0102, 0x0304", { 0x02, 0x01, 0x04, 0x03 }, 4, LITTLE },
  { ".dc16 0x0102, 0x0304", { 0x01, 0x02, 0x03, 0x04 }, 4, BIG },
  { ".dc.w 0x0102, 0x0304", { 0x02, 0x01, 0x04, 0x03 }, 4, LITTLE },
  { ".dc.w 0x0102, 0x0304", { 0x01, 0x02, 0x03, 0x04 }, 4, BIG },
  { ".dl 0x01020304, 0x0304ffaa", { 0x04, 0x03, 0x02, 0x01, 0xaa, 0xff, 0x04, 0x03 }, 8, LITTLE },
  { ".dl 0x01020304, 0x0304ffaa", { 0x01, 0x02, 0x03, 0x04, 0x03, 0x04, 0xff, 0xaa }, 8, BIG },
  { ".dc32 0x01020304, 0x0304ffaa", { 0x04, 0x03, 0x02, 0x01, 0xaa, 0xff, 0x04, 0x03 }, 8, LITTLE },
  { ".dc32 0x01020304, 0x0304ffaa", { 0x01, 0x02, 0x03, 0x04, 0x03, 0x04, 0xff, 0xaa }, 8, BIG },
  { ".dc.l 0x01020304, 0x0304ffaa", { 0x04, 0x03, 0x02, 0x01, 0xaa, 0xff, 0x04, 0x03 }, 8, LITTLE },
  { ".dc.l 0x01020304, 0x0304ffaa", { 0x01, 0x02, 0x03, 0x04, 0x03, 0x04, 0xff, 0xaa }, 8, BIG },
  { ".dc64 0x0102030405060708, 0x0304ffaa", { 0x08, 0x07, 0x06, 0x05, 0x04, 0x03, 0x02, 0x01, 0xaa, 0xff, 0x04, 0x03, 0x00, 0x00, 0x00, 0x00 }, 16, LITTLE },
  { ".dc64 0x0102030405060708, 0x0304ffaa", { 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00, 0x00, 0x03, 0x04, 0xff, 0xaa }, 16, BIG },
  { NULL }
};

void test(const char *source, uint8_t *answer, int length, int endian)
{
  struct _asm_context asm_context = { 0 };
  int oops = 0;
  int i;

  printf("Testing: %s (%s) ... ", source, endian == LITTLE ? "little":"big");

  tokens_open_buffer(&asm_context, source);
  tokens_reset(&asm_context);

  if (endian == BIG)
  {
    asm_context.memory.endian = 1;
  }

  assemble(&asm_context);

  for (i = 0; i < length; i++)
  {
    if (memory_read_m(&asm_context.memory, i) != answer[i])
    {
      oops++;
    }
  }

  if (oops != 0)
  {
    printf("FAIL\n");
    errors++;
  }
    else
  {
    printf("PASS\n");
  }

  tokens_close(&asm_context);
  assemble_free(&asm_context);
}

int main(int argc, char *argv[])
{
  int n;

  printf("directives_data.o test\n");

  n = 0;
  while(1)
  {
    if (tests[n].source == NULL) { break; }
    test(tests[n].source, tests[n].answer, tests[n].length, tests[n].endian);
    n++;
  }

  printf("Total errors: %d\n", errors);
  printf("%s\n", errors == 0 ? "PASSED." : "FAILED.");

  if (errors != 0) { return -1; }

  return 0;
}


